<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Migrations>
  <Migration EntityType="D" Name="Add support to RMA to POS Cash Close" ReleaseNo="3.9.4" SeqNo="6640">
    <Step SeqNo="10" StepType="AD">
      <PO AD_Table_ID="285" Action="U" Record_ID="55463" Table="AD_Process_Para">
        <Data AD_Column_ID="3739" Column="DefaultValue" oldValue="@SQL= SELECT SUM(o.GrandTotal * (CASE WHEN dt.DocSubTypeSO = 'RM' THEN -1 ELSE 1 END)) - COALESCE(SUM(pa.PayAmt), 0) AS OpenAmt FROM C_Order o  INNER JOIN C_DocType dt ON(dt.C_DocType_ID = o.C_DocType_ID) LEFT JOIN (         SELECT p.C_Order_ID, COALESCE(SUM(currencyconvert(p.PayAmt * (CASE WHEN p.IsReceipt = 'Y' THEN 1 ELSE -1 END), p.C_Currency_ID, ba.C_Currency_ID, p.DateAcct, p.C_ConversionType_ID, p.AD_Client_ID, p.AD_Org_ID)), 0) AS PayAmt          FROM C_Payment p          INNER JOIN C_BankAccount ba ON(ba.C_BankAccount_ID = p.C_BankAccount_ID)          WHERE p.C_POS_ID = @C_POS_ID@          AND p.DocStatus IN ('CO','CL')  GROUP BY p.C_Order_ID) pa ON(pa.C_Order_ID = o.C_Order_ID) WHERE o.C_POS_ID = @C_POS_ID@  AND o.DateOrdered BETWEEN TO_DATE('@DateTrx@','YYYY-MM-DD') AND TO_DATE('@DateTrx_To@','YYYY-MM-DD')  AND o.DocStatus IN ('CO','CL') AND o.PaymentRule = 'P'">@SQL= SELECT SUM(o.GrandTotal * (CASE WHEN dt.DocSubTypeSO = 'RM' THEN -1 ELSE 1 END)) - COALESCE(SUM(pa.PayAmt), 0) AS OpenAmt  FROM C_Order o  INNER JOIN C_DocType dt ON(dt.C_DocType_ID = o.C_DocType_ID)  LEFT JOIN (SELECT p.C_Order_ID, COALESCE(SUM(currencyconvert(p.PayAmt * (CASE WHEN p.IsReceipt = 'Y' THEN 1 ELSE -1 END), p.C_Currency_ID, ba.C_Currency_ID, p.DateAcct, p.C_ConversionType_ID, p.AD_Client_ID, p.AD_Org_ID)), 0) AS PayAmt              FROM C_Payment p              INNER JOIN C_BankAccount ba ON(ba.C_BankAccount_ID = p.C_BankAccount_ID)              AND ba.C_BankAccount_ID=@C_BankAccount_ID@             WHERE p.C_POS_ID = @C_POS_ID@              AND p.DocStatus IN ('CO','CL')              GROUP BY p.C_Order_ID) pa ON(pa.C_Order_ID = o.C_Order_ID)  WHERE o.C_POS_ID = @C_POS_ID@  AND o.DateOrdered BETWEEN TO_DATE('@DateTrx@','YYYY-MM-DD') AND TO_DATE('@DateTrx_To@','YYYY-MM-DD')  AND o.DocStatus IN ('CO','CL')  AND EXISTS(SELECT 1 FROM C_BankStatement st                  INNER JOIN C_BankStatementLine stl ON(stl.C_BankStatement_ID = st.C_BankStatement_ID)                  WHERE st.C_BankAccount_ID=@C_BankAccount_ID@                  AND st.DocStatus NOT IN('CO', 'CL')                  AND stl.C_Payment_ID = p.C_Payment_ID) AND o.PaymentRule = 'P'</Data>
      </PO>
    </Step>
    <Step SeqNo="20" StepType="AD">
      <PO AD_Table_ID="285" Action="U" Record_ID="55464" Table="AD_Process_Para">
        <Data AD_Column_ID="3739" Column="DefaultValue" oldValue="@SQL= SELECT SUM(o.GrandTotal * (CASE WHEN dt.DocSubTypeSO = 'RM' THEN -1 ELSE 1 END)) - COALESCE(SUM(pa.PayAmt), 0) AS OpenAmt FROM C_Order o  INNER JOIN C_DocType dt ON(dt.C_DocType_ID = o.C_DocType_ID) LEFT JOIN (         SELECT p.C_Order_ID, COALESCE(SUM(currencyconvert(p.PayAmt * (CASE WHEN p.IsReceipt = 'Y' THEN 1 ELSE -1 END), p.C_Currency_ID, ba.C_Currency_ID, p.DateAcct, p.C_ConversionType_ID, p.AD_Client_ID, p.AD_Org_ID)), 0) AS PayAmt          FROM C_Payment p          INNER JOIN C_BankAccount ba ON(ba.C_BankAccount_ID = p.C_BankAccount_ID)          WHERE p.C_POS_ID = @C_POS_ID@          AND p.DocStatus IN ('CO','CL')  GROUP BY p.C_Order_ID) pa ON(pa.C_Order_ID = o.C_Order_ID) WHERE o.C_POS_ID = @C_POS_ID@  AND o.DateOrdered BETWEEN TO_DATE('@DateTrx@','YYYY-MM-DD') AND TO_DATE('@DateTrx_To@','YYYY-MM-DD')  AND o.DocStatus IN ('CO','CL')">@SQL= SELECT SUM(o.GrandTotal * (CASE WHEN dt.DocSubTypeSO = 'RM' THEN -1 ELSE 1 END)) - COALESCE(SUM(pa.PayAmt), 0) AS OpenAmt  FROM C_Order o  INNER JOIN C_DocType dt ON(dt.C_DocType_ID = o.C_DocType_ID)  LEFT JOIN (SELECT p.C_Order_ID, COALESCE(SUM(currencyconvert(p.PayAmt * (CASE WHEN p.IsReceipt = 'Y' THEN 1 ELSE -1 END), p.C_Currency_ID, ba.C_Currency_ID, p.DateAcct, p.C_ConversionType_ID, p.AD_Client_ID, p.AD_Org_ID)), 0) AS PayAmt              FROM C_Payment p              INNER JOIN C_BankAccount ba ON(ba.C_BankAccount_ID = p.C_BankAccount_ID)              WHERE p.C_POS_ID = @C_POS_ID@              AND p.DocStatus IN ('CO','CL')              GROUP BY p.C_Order_ID) pa ON(pa.C_Order_ID = o.C_Order_ID)  WHERE o.C_POS_ID = @C_POS_ID@   AND o.DateOrdered BETWEEN TO_DATE('@DateTrx@','YYYY-MM-DD') AND TO_DATE('@DateTrx_To@','YYYY-MM-DD')  AND o.DocStatus IN ('CO','CL') AND EXISTS(SELECT 1 FROM C_BankStatement st                  INNER JOIN C_BankStatementLine stl ON(stl.C_BankStatement_ID = st.C_BankStatement_ID)                  WHERE st.C_BankAccount_ID=@C_BankAccount_ID@                  AND st.DocStatus NOT IN('CO', 'CL')                  AND stl.C_Payment_ID = p.C_Payment_ID)</Data>
      </PO>
    </Step>
    <Step SeqNo="30" StepType="AD">
      <PO AD_Table_ID="53232" Action="U" Record_ID="70343" Table="AD_View_Column">
        <Data AD_Column_ID="58106" Column="ColumnSQL" oldValue="ord.GrandTotal">ord.GrandTotal * (CASE WHEN pay.IsReceipt = 'Y' THEN 1 ELSE -1 END)</Data>
      </PO>
    </Step>
    <Step SeqNo="40" StepType="AD">
      <PO AD_Table_ID="53232" Action="U" Record_ID="70342" Table="AD_View_Column">
        <Data AD_Column_ID="58106" Column="ColumnSQL" oldValue="ord.TotalLines">ord.TotalLines * (CASE WHEN pay.IsReceipt = 'Y' THEN 1 ELSE -1 END)</Data>
      </PO>
    </Step>
  </Migration>
</Migrations>
